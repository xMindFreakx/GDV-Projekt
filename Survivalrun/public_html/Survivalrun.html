<html>
	<head>
            <meta name="author" content="Andreas Maisch Maxi Hartmann Anton Stein Patrick Kiermasch">
		<title>Survivalrun</title>
		<style>
			body { margin: 0; }
			canvas { width: 100%; height: 100% }
		</style>
	</head>
        <!--
            GDV Project 2015 - Gruppe NR. 5  - Survivalrun
                    created by
                    Andreas Maisch
                    Maxi Hartmann
                    Anton Stein
                    Patrick Kiermasch
        -->
	<body>
            <!--Three.js-->
		<script src="Scripts/three.js"></script>
		<script src="Scripts/OrbitControls.js"></script>
                <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
                <!-- Shaders -->
	<script type="x-shader/x-vertex" id="vertexshader">

		// switch on high precision floats

		void main()
		{
			gl_Position = projectionMatrix * modelViewMatrix * vec4(position,1.0);
		}

	</script>

	<script type="x-shader/x-fragment" id="fragmentshader">


		void main()
		{
			gl_FragColor 	= vec4(1.0,0.0,1.0,1.0);
		}

	</script>
		<script>
                    //Variables
                    var player,isGround,jumpReady,jumptime;
                    var rayCaster;
                    var oldx,oldy;
                    var collisions;
                    var renderer, scene, camera;
                    var clock;
                    var orbitController;
                    var controls;
                    var ray;
                    var rayGround;
                    var colliderObject=[];
                         
                    //Calls
                    init();
                    animate();
                    
                    //Main Start
                    function init()
                    {
                        //Init Variables
                        controls = {
                        left: false,
                        up: false,
                        right: false,
                        down: false
                        };
                        clock = new THREE.Clock();
                        jumptime=0;
                        jumpReady=false;
                        isGround=false;
                        rayGround=[false,false,false];
			scene = new THREE.Scene();
                        
                        
			renderer = new THREE.WebGLRenderer();
			renderer.setSize( window.innerWidth, window.innerHeight );
                        renderer.shadowMapEnabled = true;  //TEST
			document.body.appendChild( renderer.domElement );
                        
                        //Camera
                        camera = new THREE.PerspectiveCamera( 60, window.innerWidth / window.innerHeight, 1, 1000 );
                        camera.position.z = 7;
                        camera.position.y = 4;
                        camera.rotation.x = 12;
                        
                        //Orbitcontroller TEST
                        orbitController = new THREE.OrbitControls( camera );
                        orbitController.damping = 0.2;
                        
                        //Content
                                 
                        //Player
                        var playerText = new THREE.ImageUtils.loadTexture( 'Textures/Player/playertex.png' );
                        playerText.minFilter = THREE.NearestFilter;
//                        var playerMat = new THREE.ShaderMaterial({
//                                vertexShader:   $('#vertexshader').text(),
//                                fragmentShader: $('#fragmentshader').text()
//                        }); //MeshLambertMaterial für shadow
                     var loader = new THREE.JSONLoader();
                     loader.load( "Models/Player/steve.json", function(geometry){
                       var material = new THREE.MeshBasicMaterial({ map: playerText});//MeshLambertMaterial für shadow
                       player = new THREE.Mesh(geometry, material);
                        player.castShadow=true;
                        player.position.y = 1.5;
                       scene.add(player);
                     });
                        //PlayerspotLight
//                        var spotlight = new THREE.SpotLight(0xffff00);
//                        spotlight.position.set(0,5,0);
//                        spotlight.shadowCameraVisible = true;
//                        spotlight.shadowDarkness = 0.95;
//                        spotlight.intensity = 2;
//                        spotlight.castShadow = true;
//                        scene.add(spotlight);

                        //World
                        var mat2 = new THREE.MeshBasicMaterial( { color: 0xff0f00 } );
                        var geo2 = new THREE.BoxGeometry(100, 10, 100);
                        var cube2 = new THREE.Mesh(geo2, mat2);
                        cube2.position.y= -5;
                        scene.add(cube2);
                        
                        //box
                        var boxMat = new THREE.MeshBasicMaterial( { color: 0xff5ff0 } );
                        var boxGeo = new THREE.BoxGeometry(1, 2, 1);
                       var box = new THREE.Mesh(boxGeo, boxMat);
                        box.position.y = 1;
                        box.position.x = 2;
                        scene.add(box);
                        //box
                        var boxMat1 = new THREE.MeshBasicMaterial( { color: 0xff5ff0 } );
                        var boxGeo1 = new THREE.BoxGeometry(1, 2, 1);
                       var box2 = new THREE.Mesh(boxGeo1, boxMat1);
                        box2.position.y = 1;
                        box2.position.x = -2;
                        scene.add(box2);
                        
                        //colliderArray
                        colliderObject.push(box);
                        colliderObject.push(box2);
                        colliderObject.push(cube2);
                        
                         }
                    function animate() 
                    {
                        requestAnimationFrame( animate );
                        renderer.render( scene, camera );
                        keyboardInput();
                        collisionDetection();
                        //orbitcontrols tests
                        orbitController.update();
                        
                    }
                    function collisionDetection()
                    {
                       oldy=player.position.y;
                         ray = [
                            new THREE.Vector3(player.position.x, player.position.y-1, player.position.z), //right
                            new THREE.Vector3(player.position.x, player.position.y, player.position.z),   //right
                            new THREE.Vector3(player.position.x, player.position.y+1, player.position.z),  //right
                            new THREE.Vector3(player.position.x-0.5, player.position.y, player.position.z),//up
                            new THREE.Vector3(player.position.x, player.position.y, player.position.z),//up
                            new THREE.Vector3(player.position.x+0.5, player.position.y, player.position.z),//up
                          ];
                          
                        //Right
                        for(var i=0;i < 3; i++)
                        {
                            rayCaster = new THREE.Raycaster(ray[i],new THREE.Vector3(1,0,0),0,0.5);
                            collisions = rayCaster.intersectObjects(colliderObject);
                            if(collisions.length > 0 )//&& collisions[0].distance <= distancewd
                            {
                                player.position.x=oldx;
//                                console.log("XXXXX"+i);
                            }
                        }
                        
                        //Left
                        for(var i=0;i < 3; i++)
                        {
                            rayCaster = new THREE.Raycaster(ray[i],new THREE.Vector3(-1,0,0),0,0.5);
                            collisions = rayCaster.intersectObjects(colliderObject);
                            if(collisions.length > 0 )//&& collisions[0].distance <= distancewd
                            {
                                player.position.x=oldx;
//                                console.log("XXXXX"+i);
                            }
                        }
                        
                        //Up
                        for(var i=3;i < 6; i++)
                        {
                            rayCaster = new THREE.Raycaster(ray[i],new THREE.Vector3(0,1,0),0,1);
                            collisions = rayCaster.intersectObjects(colliderObject);
                            if(collisions.length > 0 )//&& collisions[0].distance <= distancewd
                            {
                                player.position.y=oldy;
//                                console.log("XXXXX"+i);
                            }
                        }
                        
                        //Down
                        for(var i=3;i < 6; i++)
                        {
                            rayCaster = new THREE.Raycaster(ray[i],new THREE.Vector3(0,-1,0),0,1.001);
                            collisions = rayCaster.intersectObjects(colliderObject);
                            if(collisions.length > 0 )//&& collisions[0].distance <= distancewd
                            {
//                                player.position.y=oldy;
                                rayGround[i-3]=true;
//                                console.log("XXXXX"+i);
                            }
                            else
                            {
                                rayGround[i-3]=false;
                            }
                        }
                        if(rayGround[0] || rayGround[1] || rayGround[2])
                        {
                            isGround=true;
                        }
                        else
                        {
                            isGround=false;
                            player.translateY( -0.05 );
                        }
                    }
                    function keyboardInput()
                    {
                        $(document).keydown(function (e) {
                           switch (e.keyCode) {
                               case 65:
                                   controls.left = true;
                                   break;
                               case 87:
                                   controls.up = true;
                                   break;
                               case 68:
                                   controls.right = true;
                                   break;
                               case 83:
                                   controls.down = true;
                                   break;
                                }
                         });
                        $(document).keyup(function (e) {
                            switch (e.keyCode) {
                                case 65:
                                    controls.left = false;
                                    break;
                                case 87:
                                    controls.up = false;
                                    jumptime=0;
                                    break;
                                case 68:
                                    controls.right = false;
                                    break;
                                case 83:
                                    controls.down = false;
                                    break;
                            }
                         });
                          playerControls();
                     }
                    function playerControls()
                    {
                        var move = 3 * clock.getDelta();
                        
                        if(isGround)
                        {
                            jumpReady=true;
                        }
                         if(controls.left==true)
                         {
                             oldx=player.position.x;
                               player.translateX( -move );
                         }
                         if(controls.right==true)
                         {
                             oldx=player.position.x;
                               player.translateX( move );
                         }
                         if(controls.up==true)
                         {
//                             oldy=player.position.y;
                            jumptime+=10*clock.getDelta();
                             if(jumptime<=1 && jumpReady)
                             {
                                 player.translateY( 0.15 );
                             }
                         }
                         else
                         {
                             jumpReady=false;
                         }
                         if(controls.down==true)
                         {
                         }
                    }
		</script>
	</body>
       
</html>