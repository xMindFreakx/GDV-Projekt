<html>
	<head>
        <title>Survivalrun</title>
        <meta charset="UTF-8">
            <meta name="author" content="Andreas Maisch Maxi Hartmann Anton Stein Patrick Kiermasch">
            <link href="Scripts/style.css" type="text/css" rel="stylesheet">
                <script src="Scripts/three.js"></script>
		<script src="Scripts/OrbitControls.js"></script>
                <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
	</head>
        <!--
            GDV Project 2015 - Gruppe NR. 5  - Survivalrun
                    created by
                    Andreas Maisch
                    Maxi Hartmann
                    Anton Stein
                    Patrick Kiermasch
        -->
	<body>
            
                 <!--Three.js-->
		<script>
                    //Variables
                    var player,isGround,jumpReady,jumpTime,jumpPause,groundTimer;
                    var rayCaster;
                    var oldx,oldy;
                    var collisions;
                    var renderer, scene, camera;
                    var clock,delta;
                    var orbitController;
                    var controls;
                    var ray;
                    var rayGround;
                    var objLoader;
                    var colliderObject=[];
                    var animation;
                    var menuScene;
                    var skyBox;
                    var animationdoor1,door1clock;
                    var animationdoor2,door2clock;
                    
                    
                    //init
                     init();
                    //Main Start
                    function init() 
                    {
                        //Init Variables
                        controls = {
                        left: false,
                        up: false,
                        right: false,
                        };
                        clock = new THREE.Clock();
                        objLoader = new THREE.JSONLoader();
                        jumpReady=false;
                        isGround=false;
                        firstJump= true;
                        menuScene=false;
                        rayGround=[false,false,false];
                        scene = new THREE.Scene();
                        jumpPause=clock.getElapsedTime();
                        renderer = new THREE.WebGLRenderer();
                        renderer.setSize( window.innerWidth, window.innerHeight );
                        renderer.shadowMapEnabled = true;  //TEST
                        document.body.appendChild( renderer.domElement );

                        //Camera
                        camera = new THREE.PerspectiveCamera( 60, window.innerWidth / window.innerHeight, 1, 1000 );
                        camera.position.z = 9;
                        camera.position.y = 4;
                        camera.rotation.x = 12;

                        //Orbitcontroller TEST
                        orbitController = new THREE.OrbitControls( camera );
                        orbitController.damping = 0.2;

                        //Dom
                        document.body.appendChild( renderer.domElement );
                        
                        //Menuscreen
//                        createMenu();
//                        
                        //World 1
                        createPlayer(0,1.5);
//                        createLevel1();
                       createWorld1();
                       animate();
                    }
                    function createPlayer(x,y)
                    {
                        objLoader.load( "Models/Player/player.json", function( geometry,materials ) {
                              for ( var k in materials ) 
                              {
                                   materials[k].skinning = true;
                              }
                        player = new THREE.SkinnedMesh(geometry, new THREE.MeshFaceMaterial(materials));
                        player.position.y = y;
                        player.position.x = x;
                        scene.add( player );
                        animation = new THREE.Animation( player, player.geometry.animations[ 0 ], THREE.AnimationHandler.CATMULLROM);
                        }); 
                       
                    }
                    function createMenu()
                    {
                        //World
                        var mat2 = new THREE.MeshBasicMaterial( { color: 0xff0f00 } );
                        var geo2 = new THREE.BoxGeometry(100, 10, 100);
                        cube2 = new THREE.Mesh(geo2, mat2);
                        cube2.position.y= -5;
                        scene.add(cube2);
                        animate();
                    }
                    function createWorld1()
                    {
                        //Spotlight
                        var spotlight = new THREE.SpotLight();
                        spotlight.position.set(0,100,0);
                        spotlight.shadowCameraVisible = true;
                        spotlight.shadowDarkness = 0.95;
                        spotlight.intensity = 2;
                        spotlight.castShadow = true;
                        scene.add(spotlight);
                        
                        //world 1
                        var world1;
                        var worldTexture = new THREE.ImageUtils.loadTexture( 'Models/World/world1.png' );
                        worldTexture.minFilter = THREE.NearestFilter;
                        objLoader.load( "Models/World/world1.json", function(geometry){
                        var materialworld = new THREE.MeshLambertMaterial({ map: worldTexture});
                        world1 = new THREE.Mesh(geometry, materialworld);
                        world1.castShadow=true;
                        world1.position.y = -1;
                        scene.add(world1);
                        //doors
                        var door1;
                        objLoader.load( "Models/World/Misc/door.json", function( geometry,materials ) {
                              for ( var k in materials ) 
                              {
                                   materials[k].skinning = true;
                              }
                        door1 = new THREE.SkinnedMesh(geometry, new THREE.MeshFaceMaterial(materials));
                        door1.position.y = 1;
                        door1.position.x = 45; 
                        scene.add( door1 );
                        animationdoor1 = new THREE.Animation( door1, door1.geometry.animations[ 0 ], THREE.AnimationHandler.CATMULLROM);
                       }); 
                       
                        var door2;
                        objLoader.load( "Models/World/Misc/door.json", function( geometry,materials ) {
                              for ( var k in materials ) 
                              {
                                   materials[k].skinning = true;
                              }
                        door2 = new THREE.SkinnedMesh(geometry, new THREE.MeshFaceMaterial(materials));
                        door2.position.y = 1;
                        door2.position.x = 63; 
                        scene.add( door2 );
                        animationdoor2 = new THREE.Animation( door2, door2.geometry.animations[ 0 ], THREE.AnimationHandler.CATMULLROM);
                       }); 
                       
                        //skybox
                        var skyPath = "Models/World/Skybox/sky";
                        var skyDir  = ["left", "right", "up", "down", "back", "front"];
                        var skyType = ".png";
                        var skyGeometry = new THREE.BoxGeometry( 80, 80, 80 );	
                        var skyMat = [];
                        for (var i = 0; i < 6; i++)
                                skyMat.push( new THREE.MeshBasicMaterial({
                                        map: THREE.ImageUtils.loadTexture( skyPath + skyDir[i] + skyType ),
                                        side: THREE.BackSide,
                                }));
                        var skyMaterial = new THREE.MeshFaceMaterial( skyMat );
                        skyBox = new THREE.Mesh( skyGeometry, skyMaterial );
                        scene.add( skyBox );
                        
                        //collision
                        colliderObject.push(world1);
                     });
                    }
                    function addTorch()
                    {
                    }
                    function world1Events()
                    {
                        //door1
                        if(player.position.x < 3)
                        {
                            animationdoor1.play();
                            door1clock = clock.getElapsedTime()+1;
                        }
                        if(clock.getElapsedTime() > door1clock)
                        {
                            animationdoor1.stop();
                        }
                        //door2
                        if(player.position.x < 61)
                        {
                            animationdoor2.play();
                            door2clock = clock.getElapsedTime()+1;
                        }
                        if(clock.getElapsedTime() > door2clock)
                        {
                            animationdoor2.stop();
                        }
                    }
                    function animate() 
                    {
                        requestAnimationFrame(animate);
                        renderer.render( scene, camera );
                        if(!menuScene)
                        {
                            THREE.AnimationHandler.update( clock.getDelta()*10 );
                            keyboardInput();
                            collisionDetection();
                            world1Events()
                            delta = clock.getDelta(); // delta time;
                            //orbitcontrols tests
//                            orbitController.update(); 
                            camerafollower();
                        }
                    }
                    function camerafollower()
                    {
                        //Camera 
                        camera.position.x = player.position.x+1;
                        camera.position.y = player.position.y+5;
                        //skybox
                        skyBox.position.x = player.position.x;
                    }
                    
                    function collisionDetection()
                    {
                       oldy=player.position.y;
                         ray = [
                            new THREE.Vector3(player.position.x, player.position.y+0.15, player.position.z), //right left bottom
                            new THREE.Vector3(player.position.x, player.position.y+1.30, player.position.z), //right left mid
                            new THREE.Vector3(player.position.x, player.position.y+2.30, player.position.z),  //right left Upper
                            new THREE.Vector3(player.position.x, player.position.y+2.90, player.position.z),  //right left Head
                            new THREE.Vector3(player.position.x-0.36, player.position.y+0.4, player.position.z),//up down
                            new THREE.Vector3(player.position.x, player.position.y+0.4, player.position.z),//up down
                            new THREE.Vector3(player.position.x+0.36, player.position.y+0.4, player.position.z),//up down
                          ];
                          
                          
                        //Right
                        for(var i=0;i < 4; i++)
                        {
                            rayCaster = new THREE.Raycaster(ray[i],new THREE.Vector3(1,0,0),0,0.35);
                            collisions = rayCaster.intersectObjects(colliderObject);
                            if(collisions.length > 0 )
                            {
                                player.position.x=oldx;
                            }
                        }
                        
                        //Left
                        for(var i=0;i < 4; i++)
                        {
                            rayCaster = new THREE.Raycaster(ray[i],new THREE.Vector3(-1,0,0),0,0.35);
                            collisions = rayCaster.intersectObjects(colliderObject);
                            if(collisions.length > 0 )
                            {
                                player.position.x=oldx;
                            }
                        }
                        
                        //Up
                        for(var i=4;i < 7; i++)
                        {
                            rayCaster = new THREE.Raycaster(ray[i],new THREE.Vector3(0,1,0),0.3);
                            collisions = rayCaster.intersectObjects(colliderObject);
                            if(collisions.length > 0 )
                            {
                                player.position.y=oldy;
                            }
                        }
                        
                        //Down
                        for(var i=4;i < 7; i++)
                        {
                            rayCaster = new THREE.Raycaster(ray[i],new THREE.Vector3(0,-1,0),0,0.3);
                            collisions = rayCaster.intersectObjects(colliderObject);
                            if(collisions.length > 0 )
                            {
                                rayGround[i-4]=true;
                            }
                            else
                            {
                                rayGround[i-4]=false;
                            }
                        }
                        if(rayGround[0] || rayGround[1] || rayGround[2])
                        {
                            isGround=true;
                        }
                        else
                        {
                            isGround=false;
                            player.translateY( -0.05 );
                        }
                    }
                    function keyboardInput()
                    {
                        $(document).keydown(function (e) {
                           switch (e.keyCode) {
                               case 65:
                                   controls.left = true;
                                   break;
                               case 87:
                                   controls.up = true;
                                   break;
                               case 68:
                                   controls.right = true;
                                   break;
                               case 83:
                                   controls.down = true;
                                   break;
                                }
                         });
                        $(document).keyup(function (e) {
                            switch (e.keyCode) {
                                case 65:
                                    controls.left = false;
                                    break;
                                case 87:
                                    controls.up = false;
                                    break;
                                case 68:
                                    controls.right = false;
                                    break;
                                case 83:
                                    controls.down = false;
                                    break;
                            }
                         });
                          playerControls();
                     }
                    function playerControls()
                    {
                        var move = 0.07;
                        playerMoveAnimation();
                        if(isGround)
                        {
                            //JumpPause
                            if(groundTimer)
                            {
                                jumpPause = clock.getElapsedTime();
                                groundTimer=false;
                            }
                            if(clock.getElapsedTime()> jumpPause+0.08 && !groundTimer)
                            {
                                jumpReady=true;
                                firstJump=false;
                                jumpTime =clock.getElapsedTime()
                            }
                        }
                        else
                        {
                            groundTimer=true;
                        }
                         if(controls.left==true)
                         {
                             oldx=player.position.x;
                               player.translateX( -move );
                         }
                         if(controls.right==true)
                         {
                             oldx=player.position.x;
                               player.translateX( move );
                         }
                         if(controls.up==true)
                         {
                             if(clock.getElapsedTime()<(jumpTime+0.5) && jumpReady)
                             {
                                 player.translateY( 0.15 );
                                 jumpPause = clock.getElapsedTime();
                             }
                         }
                         else
                         {
                             jumpReady=false;
                         }
                    }
                    function playerMoveAnimation()
                    {
                        if(controls.left || controls.right || controls.up || jumpReady)
                        {
                            if(!animation.isPlaying)
                            {
                                animation.play(animation.currentTime);
                            }
                        }
                        else
                        {
                            animation.stop();
                        }
                    }
		</script>
	</body>
       
</html>