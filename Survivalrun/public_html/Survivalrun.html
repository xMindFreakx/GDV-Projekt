<html>
	<head>
        <title>Survivalrun</title>
        <meta charset="UTF-8">
            <meta name="author" content="Andreas Maisch Maxi Hartmann Anton Stein Patrick Kiermasch">
            <link href="Scripts/style.css" type="text/css" rel="stylesheet">
                <script src="Scripts/three.js"></script>
		<script src="Scripts/OrbitControls.js"></script>
                <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
	</head>
        <!--
            GDV Project 2015 - Gruppe NR. 5  - Survivalrun
                    created by
                    Andreas Maisch
                    Patrick Kiermasch
        -->
	<body>
            <div id="highscoreview">
                <a id="highscoretext">Highscore 0</a>
            </div>
            <div id="hpammo">
                <img src="GUI/heart.png" height="35" id="heart1"><img src="GUI/heart.png" height="35" id="heart2"><img src="GUI/heart.png" height="35" id="heart3"><br>
                <a id="ammo">2 x </a><img src="GUI/arrow.png" height="40">
            </div>
            <div id="timeview">
                <a id="timeviewtext">00:00</a>
            </div>
            <div id="pause">
                <a id="pausetext"></a>
            </div>
             <div id="ammotxt">
                <a id="noammotext"></a>
            </div>
		<script>
                    //Variables
                    var player,isGround,jumpReady,jumpTime,jumpPause,groundTimer,playerMoveSpeed,fallSpeed,playerHP,playerArrowAmmo,arrowSpeed,arrowInScene;
                    var sword,bow,arrow,arrowAirTime;
                    var playerAnimation,animationSword,animationSwordPlaying,animationBow,animationBowPlaying,animationLoaded;
                    var sawSpeed;
                    var rayCaster;
                    var oldx,oldy;
                    var collisions;
                    var renderer, scene, camera;
                    var orbitController;
                    var controls;
                    var ray;
                    var rayGround;
                    var objLoader;
                    var colliderObject=[];
                    var sawcollider=[];
                    var menuScene;
                    var skyBox;
                    var escMenu;
                    var highscoreValue,highscoreEverySecondsAmount;
                    var saw;
                    
                    //time vars
                    var clock,localSeconds=0,localTimeID,outOfAmmoTime;
                    
                    //HMTL

                    //ESC-Pause
                     $(document).keyup(function (e) {
                            if(e.which == 27) {
                                 if(!escMenu)
                                 {
                                    escMenu=true;
                                    document.getElementById("pausetext").innerHTML="~ Pause ~";
                                    stopLocalTime();
                                 }
                                 else
                                 {
                                    escMenu=false;
                                    document.getElementById("pausetext").innerHTML="";
                                    startLocalTime();
                                 }
                             }
                         });
                         //Weapons
                        $(document).keydown(function (e) {
                            if(!escMenu)
                            {
                                if(e.keyCode==32 && !animationSwordPlaying && !animationBowPlaying)
                                {
                                    playerSwordAttack(player.position.x,player.position.y);
                                }
                                if(e.keyCode==67 && !animationBowPlaying && !animationSwordPlaying && !arrowInScene && playerArrowAmmo>0)
                                {
                                    playerBowAttack(player.position.x,player.position.y);
                                }
                                if(e.keyCode==67 && playerArrowAmmo<=0)
                                {
                                    document.getElementById("noammotext").innerHTML="~ out of ammo ~";
                                    outOfAmmoTime=localSeconds+2;
                                }
                            }
                         });
                        //Controls
                        $(document).keydown(function (e) {
                                switch (e.keyCode) {
                                    case 65:
                                        controls.left = true;
                                        break;
                                    case 87:
                                        controls.up = true;
                                        break;
                                    case 68:
                                        controls.right = true;
                                        break;
                                    case 83:
                                        controls.down = true;
                                        break;
                                }
                         });
                        $(document).keyup(function (e) {
                                switch (e.keyCode) {
                                    case 65:
                                        controls.left = false;
                                        break;
                                    case 87:
                                        controls.up = false;
                                        break;
                                    case 68:
                                        controls.right = false;
                                        break;
                                    case 83:
                                        controls.down = false;
                                        break;
                                }
                        });
                        //Time
                    function startLocalTime()
                    {
                        localTimeID =  window.setInterval(function() {
                        ++localSeconds;
                        timer();
                        if((localSeconds%5)==0)
                        {
                            addHighscoreValue(highscoreEverySecondsAmount);
                        }
                      }, 1000);
                    }
                    function stopLocalTime()
                    {
                        window.clearInterval(localTimeID);
                    }
                         //HP-Bar
                    function removeHeartHTML()
                    {
                       if(playerHP>0)
                       {
                           document.getElementById("heart"+playerHP).src="GUI/heartempty.png";
                       }
                       if(playerHP===0)
                       {
                           $("#heart1").hide();
                           $("#heart2").hide();
                           $("#heart3").hide();
                           //deathscreen
                       }
                       playerHP--;
                    }
                    function addHeartHTML()
                    {
                       if(playerHP=>4)
                       {
                          //do nothing
                       }
                       else
                       {
                           playerHP++;
                           document.getElementById("heart"+playerHP).src="GUI/heart.png";
                       }

                    }
                    function addArrowHTML()
                    {
                       if(playerArrowAmmo=>9)
                       {
                          //do nothing
                       }
                       else
                       {
                           playerArrowAmmo++;
                           document.getElementById("ammo").innerHTML=+playerArrowAmmo+" x ";
                       }
                    }
                    function removeArrowHTML()
                    {
                       if(playerArrowAmmo<1)
                       {
                          //do nothing
                       }
                       else
                       {
                           playerArrowAmmo--;
                           document.getElementById("ammo").innerHTML=+playerArrowAmmo+" x ";
                       }
                    }
                    function outOfAmmoHTML()
                    {
                        if(localSeconds>=outOfAmmoTime)
                        {
                            document.getElementById("noammotext").innerHTML="";
                        }
                    }
                    function updateHighscore()
                    {
                        document.getElementById("highscoretext").innerHTML="Highscore "+highscoreValue;
                    }
                    function addHighscoreValue(value)
                    {
                        highscoreValue=highscoreValue+value;
                    }
                    function timer()
                    {
                        minute = parseInt(localSeconds/60);
                        second = parseInt(localSeconds%60);
                        if(minute<10)
                        {
                           minute ="0"+minute;
                        }
                        if(minute>=60)
                        {
                            minute=59;
                        }
                        if(second<10)
                        {
                            second="0"+second;
                        }
                        document.getElementById("timeviewtext").innerHTML=minute+":"+second;
                    }
                    //THREE JS
                     init();
                    //Main Start
                    function init() 
                    {
                        //Init Variables
                        controls = {
                        left: false,
                        up: false,
                        right: false,
                        };
                        clock = new THREE.Clock();
                        loadManager = new THREE.LoadingManager();
                        objLoader = new THREE.JSONLoader();
                        jumpReady=false;
                        isGround=false;
                        menuScene=false;
                        rayGround=[false,false,false];
                        highscoreValue=0;
                        
                        //Playersettings
                        playerMoveSpeed=0.6;
                        sawSpeed=0.4;
                        jumpSpeed=1;
                        fallSpeed=0.35;
                        playerHP=3;
                        playerArrowAmmo=2;
                        arrowSpeed=playerMoveSpeed*3;
                        
                        highscoreEverySecondsAmount=10;
                        
                        scene = new THREE.Scene();
                        jumpPause=clock.getElapsedTime();
                        renderer = new THREE.WebGLRenderer({ antialias: true});
                        renderer.setSize( window.innerWidth, window.innerHeight );
                        renderer.shadowMapEnabled = true;  //TEST
                        renderer.shadowMapType = THREE.PCFSoftShadowMap;
                        
                        document.body.appendChild( renderer.domElement );

                        //Camera
                        camera = new THREE.PerspectiveCamera( 60, window.innerWidth / window.innerHeight, 1, 1000 );
                        camera.position.z = 60;
                        camera.position.y = 40;
                        camera.rotation.x = 12;

                        //Orbitcontroller TEST
                        orbitController = new THREE.OrbitControls( camera );
                        orbitController.damping = 0.2;

                        //Dom
                        document.body.appendChild( renderer.domElement );
                        //Menuscreen
//                        createMenu();
                        //Preload Texture
                        preLoadWeapons();
                        //World 1
                        createPlayer(8,20.5); //8
//                        createMenu();
                       createWorld1();
                       animate();
                    }
                    function createPlayer(x,y)
                    {
                        objLoader.load( "Models/Player/player.json", function( geometry,materials ) {
                              for ( var k in materials ) 
                              {
                                   materials[k].skinning = true;
                              }
                        player = new THREE.SkinnedMesh(geometry, new THREE.MeshFaceMaterial(materials));
                        player.position.y = y;
                        player.position.x = x;
                        player.scale.set(5,5,5);
                        player.castShadow =true;
                        player.receiveShadow =true;
                        scene.add( player );
                        playerAnimation = new THREE.Animation( player, player.geometry.animations[ 0 ], THREE.AnimationHandler.CATMULLROM);
                        }); 
                       
                    }
                    function playerSwordAttack()
                    {
                        objLoader.load( "Models/Player/sword.json", function( geometry,materials ) {
                              for ( var k in materials ) 
                              {
                                   materials[k].skinning = true;
                              }
                        sword = new THREE.SkinnedMesh(geometry, new THREE.MeshFaceMaterial(materials));
                        sword.position.y = player.position.y;
                        sword.position.x = player.position.x;
                        sword.scale.set(5,5,5);
                        sword.castShadow =true;
                        sword.receiveShadow =true;
                        scene.add( sword );
                        animationSword = new THREE.Animation( sword, sword.geometry.animations[ 0 ], THREE.AnimationHandler.CATMULLROM);
                        animationSword.play();
                        animationSword.loop=false;
                        animationSwordPlaying=true;
                        });
                    }
                    function playerBowAttack()
                    {
                        objLoader.load( "Models/Player/bow.json", function( geometry,materials ) {
                              for ( var k in materials ) 
                              {
                                   materials[k].skinning = true;
                              }
                        bow = new THREE.SkinnedMesh(geometry, new THREE.MeshFaceMaterial(materials));
                        bow.position.y = player.position.y;
                        bow.position.x = player.position.x;
                        bow.scale.set(5,5,5);
                        bow.castShadow =true;
                        bow.receiveShadow =true;
                        scene.add( bow );
                        animationBow = new THREE.Animation( bow, bow.geometry.animations[ 0 ], THREE.AnimationHandler.CATMULLROM);
                        animationBow.play();
                        animationBow.loop=false;
                        animationBowPlaying=true;
                        });
                        var arrowTex = new THREE.ImageUtils.loadTexture( 'Models/Player/arrow.png' );
                        arrowTex.minFilter = THREE.NearestFilter;
                        objLoader.load( "Models/Player/arrow.json", function(geometry){
                        var arrowMat = new THREE.MeshLambertMaterial({ map: arrowTex});
                        arrow = new THREE.Mesh(geometry, arrowMat);
                        arrow.castShadow=true;
                        arrow.receiveShadow=true;
                        arrow.position.y = player.position.y;
                        arrow.position.x = player.position.x;
                        arrow.scale.set(5,5,5);
                        scene.add(arrow);
                        removeArrowHTML();
                        arrowInScene=true;
                        arrowAirTime = localSeconds+2;
//                        arrowCollision(arrow);
                        });
                    }
                    function arrowCollision()
                    {
                        arrow.translateX( arrowSpeed );
                        rayCaster = new THREE.Raycaster(new THREE.Vector3(arrow.position.x+6, arrow.position.y+9, arrow.position.z-0.15),new THREE.Vector3(1,0,0),0,2);
                        collisions = rayCaster.intersectObjects(colliderObject);
                        if(collisions.length > 0 || localSeconds >=arrowAirTime)
                        {
                            scene.remove(arrow);
                            arrowInScene=false;
                        }
                    }
                    function preLoadWeapons()
                    {
                        var obj;
                        objLoader.load( "Models/Player/bow.json", function( geometry,materials ) {
                              for ( var k in materials ) 
                              {
                                   materials[k].skinning = true;
                              }
                        obj = new THREE.SkinnedMesh(geometry, new THREE.MeshFaceMaterial(materials));
                        obj.position.y = player.position.y;
                        obj.position.x = player.position.x;
                        obj.scale.set(5,5,5);
                        obj.castShadow =true;
                        obj.receiveShadow =true;
                        scene.add( obj );
                        scene.remove(obj);
                        });
                        objLoader.load( "Models/Player/sword.json", function( geometry,materials ) {
                              for ( var k in materials ) 
                              {
                                   materials[k].skinning = true;
                              }
                        obj = new THREE.SkinnedMesh(geometry, new THREE.MeshFaceMaterial(materials));
                        obj.position.y = player.position.y;
                        obj.position.x = player.position.x;
                        obj.scale.set(5,5,5);
                        obj.castShadow =true;
                        obj.receiveShadow =true;
                        scene.add( obj );
                        scene.remove(obj);
                        });
                    }
                    function createMenu()
                    {
                        //World
                        var mat2 = new THREE.MeshBasicMaterial( { color: 0xff0f00 } );
                        var geo2 = new THREE.BoxGeometry(100, 10, 100);
                        cube2 = new THREE.Mesh(geo2, mat2);
                        cube2.position.y= -5;
                        scene.add(cube2);
                        animate();
                    }
                    function createWorld1()
                    {
                        //sunlight
                        var sunLight = new THREE.DirectionalLight( 0xffffff, 1);
                        sunLight.position.set(100,200,+100);
//                        sunLight.shadowCameraVisible = true;
                        sunLight.shadowDarkness = 1.95;
                        sunLight.intensity = 0.1;
                        sunLight.castShadow = true;
                        sunLight.shadowMapHeight = 4098;
                        sunLight.shadowMapWidth = 4098;
                        scene.add(sunLight)
                        
                        //world-light
//                        var ambientLight = new THREE.AmbientLight( 0x404040,2 ); // soft white light
//                        scene.add( ambientLight );
                        var hemiLight = new THREE.HemisphereLight( 0xffffbb, 0x080820, 1 );
                        scene.add( hemiLight );

                        //world 1
                        var world1;
                        var worldTexture = new THREE.ImageUtils.loadTexture( 'Models/World/world1.png' );
                        worldTexture.minFilter = THREE.NearestFilter;
                        objLoader.load( "Models/World/world1.json", function(geometry){
                        var materialworld = new THREE.MeshLambertMaterial({ map: worldTexture});
                        world1 = new THREE.Mesh(geometry, materialworld);
                        world1.castShadow=true;
                        world1.receiveShadow=true;
                        world1.position.y = -1;
                        world1.scale.set(5,5,5);
                        scene.add(world1);
                        colliderObject.push(world1);
                        });
                        var door;
                        var doorTexture = new THREE.ImageUtils.loadTexture( 'Models/Misc/door.png' );
                        worldTexture.minFilter = THREE.NearestFilter;
                        objLoader.load( "Models/Misc/door.json", function(geometry){
                        var materialdoor = new THREE.MeshLambertMaterial({ map: doorTexture});
                        door = new THREE.Mesh(geometry, materialdoor);
                        door.castShadow=true;
                        door.receiveShadow=true;
                        door.position.y = 8;
                        door.position.x = 282;
                        door.position.z = 9;
                        door.scale.set(5,5,5);
                        scene.add(door);
                        });
                        
                        //Saw
                        var sawTexture = new THREE.ImageUtils.loadTexture( 'Models/Misc/saw.png' );
                        worldTexture.minFilter = THREE.NearestFilter;
                        objLoader.load( "Models/Misc/saw.json", function(geometry){
                        var materialworld = new THREE.MeshLambertMaterial({ map: sawTexture});
                        saw = new THREE.Mesh(geometry, materialworld);
                        saw.castShadow=true;
                        saw.receiveShadow=true;
                        saw.position.y = 10;
                        saw.position.x = -50;
                        saw.scale.set(5,5,5);
                        scene.add(saw);
//                        sawcolliderdw.push(world1);
                        });
                        
                        //skybox
                        var skyPath = "Models/World/Skybox/sky";
                        var skyDir  = ["left", "right", "up", "down", "back", "front"];
                        var skyType = ".png";
                        var skyGeometry = new THREE.BoxGeometry( 150, 150, 150 );	
                        var skyMat = [];
                        for (var i = 0; i < 6; i++)
                                skyMat.push( new THREE.MeshBasicMaterial({
                                        map: THREE.ImageUtils.loadTexture( skyPath + skyDir[i] + skyType ),
                                        side: THREE.BackSide,
                                }));
                        var skyMaterial = new THREE.MeshFaceMaterial( skyMat );
                        skyBox = new THREE.Mesh( skyGeometry, skyMaterial );
                        skyBox.scale.set(5,5,5);
                        scene.add( skyBox );
                        
                        //Time
                        startLocalTime();
                    }
                    function world1Events()
                    {
                        if(!escMenu)
                        {
                            saw.translateX( sawSpeed );
                            if(arrowInScene)
                            {
                                arrowCollision();
                            }
                        }
                    }
                    function camerafollower()
                    {
                        //Camera 
                        camera.position.x = player.position.x+5;
                        camera.position.y = player.position.y+25;
                        //skybox
                        skyBox.position.x = player.position.x;
                    }
                    function collisionDetection()
                    {
                       oldy=player.position.y;
                         ray = [
                            new THREE.Vector3(player.position.x, player.position.y+1, player.position.z), //right left bottom
                            new THREE.Vector3(player.position.x, player.position.y+6.50, player.position.z), //right left mid
                            new THREE.Vector3(player.position.x, player.position.y+11.50, player.position.z),  //right left Upper
                            new THREE.Vector3(player.position.x, player.position.y+14.50, player.position.z),  //right left Head
                            new THREE.Vector3(player.position.x-1.8, player.position.y+2, player.position.z),//up down
                            new THREE.Vector3(player.position.x, player.position.y+2, player.position.z),//up down
                            new THREE.Vector3(player.position.x+1.8, player.position.y+2, player.position.z),//up down
                          ];
                        //Right
                        for(var i=0;i < 4; i++)
                        {
                            rayCaster = new THREE.Raycaster(ray[i],new THREE.Vector3(1,0,0),0,1.75);
                            collisions = rayCaster.intersectObjects(colliderObject);
                            if(collisions.length > 0 )
                            {
                                player.position.x=oldx;
                            }
                        }
                        
                        //Left
                        for(var i=0;i < 4; i++)
                        {
                            rayCaster = new THREE.Raycaster(ray[i],new THREE.Vector3(-1,0,0),0,1.75);
                            collisions = rayCaster.intersectObjects(colliderObject);
                            if(collisions.length > 0 )
                            {
                                player.position.x=oldx;
                            }
                        }
                        
                        //Up
                        for(var i=4;i < 7; i++)
                        {
                            rayCaster = new THREE.Raycaster(ray[i],new THREE.Vector3(0,1,0),1.5);
                            collisions = rayCaster.intersectObjects(colliderObject);
                            if(collisions.length > 0 )
                            {
                                player.position.y=oldy;
                            }
                        }
                        
                        //Down
                        for(var i=4;i < 7; i++)
                        {
                            rayCaster = new THREE.Raycaster(ray[i],new THREE.Vector3(0,-1,0),0,2);
                            collisions = rayCaster.intersectObjects(colliderObject);
                            if(collisions.length > 0 )
                            {
                                rayGround[i-4]=true;
                            }
                            else
                            {
                                rayGround[i-4]=false;
                            }
                        }
                        if(rayGround[0] || rayGround[1] || rayGround[2])
                        {
                            isGround=true;
                        }
                        else
                        {
                            if(!escMenu)
                            {
                                isGround=false;
                                player.translateY( -fallSpeed );
                            }
                        }
                    }
                    function playerControls()
                    {
                        playerMoveAnimation();
                        if(!escMenu)
                        {
                            if(isGround)
                            {
                                //JumpPause
                                if(groundTimer)
                                {
                                    jumpPause = clock.getElapsedTime();
                                    groundTimer=false;
                                }
                                if(clock.getElapsedTime()> jumpPause+0.08 && !groundTimer)
                                {
                                    jumpReady=true;
                                    jumpTime =clock.getElapsedTime()
                                }
                            }
                            else
                            {
                                groundTimer=true;
                            }
                             if(controls.left==true)
                             {
                                oldx=player.position.x;
                                player.translateX( -playerMoveSpeed );
                             }
                             if(controls.right==true)
                             {
                                oldx=player.position.x;
                                player.translateX( playerMoveSpeed );
                             }
                             if(controls.up==true)
                             {
                                 if(clock.getElapsedTime()<(jumpTime+0.5) && jumpReady)
                                 {
                                     player.translateY( jumpSpeed );
                                     jumpPause = clock.getElapsedTime()*clock.getDelta()*100;
                                 }
                             }
                             else
                             {
                                 jumpReady=false;
                             }
                        }
                    }
                    function weaponControls()
                    {
                            if(animationSwordPlaying)
                            {
                                sword.position.x=player.position.x;
                                sword.position.y=player.position.y;
                                if(!animationSword.isPlaying)
                                {
                                    scene.remove(sword);
                                    animationSwordPlaying=false;
                                }
                            }
                            if(animationBowPlaying)
                            {
                                bow.position.x=player.position.x;
                                bow.position.y=player.position.y;
                                if(!animationBow.isPlaying)
                                {
                                    scene.remove(bow);
                                    animationBowPlaying=false;
                                }
                            }
                    }
                    function playerMoveAnimation()
                    {
                        if((controls.left || controls.right || controls.up) && !escMenu)
                        {
                            if(!playerAnimation.isPlaying)
                            {
                                playerAnimation.play(playerAnimation.currentTime);
                            }
                        }
                        else
                        {
                            playerAnimation.stop();
                        }
                    }
                    function animate() 
                    {
                        requestAnimationFrame(animate);
                        renderer.render( scene, camera );
                        if(!menuScene)
                        {
                            THREE.AnimationHandler.update( 0.05 );
                            collisionDetection();
                            world1Events();
                            //orbitcontrols tests
//                            orbitController.update(); 
                            outOfAmmoHTML();
                            camerafollower();
                            updateHighscore();
                            playerControls();
                            weaponControls();
                        }
                    }
		</script>
	</body>
       
</html>