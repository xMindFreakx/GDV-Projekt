<html>
    <head>
        <meta name="author" content="Andreas Maisch Maxi Hartmann Anton Stein Patrick Kiermasch">
        <title>Survivalrun</title>
        <style>
            body { margin: 0; }
            canvas { width: 100%; height: 100% }
        </style>
    </head>
    <!--
        GDV Project 2015 - Gruppe NR. 5  - Survivalrun
                created by
                Andreas Maisch
                Maxi Hartmann
                Anton Stein
                Patrick Kiermasch
    -->
    <body>
        <!--Three.js-->
        <script src="Scripts/three.js"></script>
        <script src="Scripts/OrbitControls.js"></script>
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
        <!-- Shaders -->
        <script type="x-shader/x-vertex" id="vertexshader">

            // switch on high precision floats

            void main()
            {
            gl_Position = projectionMatrix * modelViewMatrix * vec4(position,1.0);
            }

        </script>

        <script type="x-shader/x-fragment" id="fragmentshader">


            void main()
            {
            gl_FragColor 	= vec4(1.0,0.0,1.0,1.0);
            }

        </script>
        <script>
//Variables
            var player, isGround, jumpReady, jumptime;
            var rayCaster, rayCasterEnemy;
            var oldx, oldy;
            var collisionObjects, collisionEnemy;
            var renderer, scene, camera;
            var clock;
            var orbitController;
            var controls;
            var ray;
            var rayGround;
            var colliderObject = [];
            var enemyObject = [];
            
//Enemyvariablen
            var enemySpeedZombie=0.025;
            var testEnemyBox1;

//Gamerule Variablen
            var health;
            var maxHealth;
            var invincibleTimer;
            var isInvincible;
            var counter;

//Calls
            init();
            animate();



//Main Start
            function init()
            {
                isInvincible = false;
                maxHealth = 10;
                
                //Init Variables
                controls = {
                    left: false,
                    up: false,
                    right: false,
                    down: false
                };
                player = new THREE.Mesh(); //Error fixed
                clock = new THREE.Clock();
                jumptime = 0;
                jumpReady = false;
                isGround = false;
                rayGround = [false, false, false];

                health = 10;
                scene = new THREE.Scene();


                renderer = new THREE.WebGLRenderer();
                renderer.setSize(window.innerWidth, window.innerHeight);
                renderer.shadowMapEnabled = true;  //TEST
                document.body.appendChild(renderer.domElement);

                //Camera
                camera = new THREE.PerspectiveCamera(60, window.innerWidth / window.innerHeight, 1, 1000);
                camera.position.set(0, 2, 13);

                //Orbitcontroller TEST
                orbitController = new THREE.OrbitControls(camera);
                orbitController.damping = 0.2;

                //Content

                //Player
                var playerText = new THREE.ImageUtils.loadTexture('Textures/Player/playertex.png');
                playerText.minFilter = THREE.NearestFilter;
//                        var playerMat = new THREE.ShaderMaterial({
//                                vertexShader:   $('#vertexshader').text(),
//                                fragmentShader: $('#fragmentshader').text()
//                        }); //MeshLambertMaterial für shadow
                var loader = new THREE.JSONLoader();
                loader.load("Models/Player/steve.json", function (geometry) {
                    var material = new THREE.MeshBasicMaterial({map: playerText});//MeshLambertMaterial für shadow
                    player = new THREE.Mesh(geometry, material);
                    player.castShadow = true;
                    player.position.y = 1.5;
                    player.add(camera);
                    scene.add(player);
                });
                //PlayerspotLight
//                        var spotlight = new THREE.SpotLight(0xffff00);
//                        spotlight.position.set(0,5,0);
//                        spotlight.shadowCameraVisible = true;
//                        spotlight.shadowDarkness = 0.95;
//                        spotlight.intensity = 2;
//                        spotlight.castShadow = true;
//                        scene.add(spotlight);

                //World
                var mat2 = new THREE.MeshBasicMaterial({color: 0xff0f00});
                var geo2 = new THREE.BoxGeometry(100, 10, 100);
                var cube2 = new THREE.Mesh(geo2, mat2);
                cube2.position.y = -5;
                scene.add(cube2);

                //box
                var boxMat = new THREE.MeshBasicMaterial({color: 0xff5ff0});
                var boxGeo = new THREE.BoxGeometry(1, 2, 1);
                var box = new THREE.Mesh(boxGeo, boxMat);
                box.position.y = 1;
                box.position.x = 2;
                scene.add(box);
                //box
                var boxMat1 = new THREE.MeshBasicMaterial({color: 0xff5ff0});
                var boxGeo1 = new THREE.BoxGeometry(1, 2, 1);
                var box2 = new THREE.Mesh(boxGeo1, boxMat1);
                box2.position.y = 1;
                box2.position.x = -2;
                scene.add(box2);

                //colliderArray
                colliderObject.push(box);
                colliderObject.push(box2);
                colliderObject.push(cube2);



                //testenemy                        
                var testEnemyMat1 = new THREE.MeshBasicMaterial({color: 0x000000});
                var testEnemyGeo1 = new THREE.BoxGeometry(1, 2, 1);
                testEnemyBox1 = new THREE.Mesh(testEnemyGeo1, testEnemyMat1);
                testEnemyBox1.position.y = 1;
                testEnemyBox1.position.x = 15;
                scene.add(testEnemyBox1);

                enemyObject.push(testEnemyBox1);
                colliderObject.push(testEnemyBox1);
            }
//---------------------------------------------------------------------------------------------------
            function animate()
            {
                requestAnimationFrame(animate);
                renderer.render(scene, camera);
                keyboardInput();
                collisionDetection();
                //orbitcontrols tests
                orbitController.update();
                addAI();
            }
//---------------------------------------------------------------------------------------------------
            function addAI()
            {
                enemyAI(testEnemyBox1);
            }
//---------------------------------------------------------------------------------------------------
            function enemyAI(enemy)
            {
                var collisionEnemys,    //Variable für die Playerkollision
                    collisionWorld;     //Variable für sonstige Hindernisse
                var playerarray = [player];

                rayCasterEnemy = new THREE.Raycaster(new THREE.Vector3(enemy.position.x, enemy.position.y, enemy.position.z), new THREE.Vector3(-1, 0, 0), 0, 5);       //Raycaster für den Player
                rayCasterWorld = new THREE.Raycaster(new THREE.Vector3(enemy.position.x, enemy.position.y, enemy.position.z), new THREE.Vector3(-1, 0, 0), 0, 0.5);     //Raycaster für sonstige Hindernisse
                collisionEnemys = rayCasterEnemy.intersectObjects(playerarray);         //Abfrage für den Player
                collisionWorld = rayCasterWorld.intersectObjects(colliderObject);       //Abfrage für sonstige Hindernisse in der Welt
                if (collisionEnemys.length > 0 && collisionWorld.length === 0)
                {
                    //console.log("Zeile1");
                    enemy.translateX(-enemySpeedZombie);
                }
                else
                {
                    
                }
                    

                rayCasterEnemy = new THREE.Raycaster(new THREE.Vector3(enemy.position.x, enemy.position.y, enemy.position.z), new THREE.Vector3(1, 0, 0), 0, 5);       //Raycaster für den Player
                rayCasterWorld = new THREE.Raycaster(new THREE.Vector3(enemy.position.x, enemy.position.y, enemy.position.z), new THREE.Vector3(1, 0, 0), 0, 0.5);     //Raycaster für sonstige Hindernisse
                collisionEnemys = rayCasterEnemy.intersectObjects(playerarray);         //Abfrage für den Player
                collisionWorld = rayCasterWorld.intersectObjects(colliderObject);       //Abfrage für sonstige Hindernisse in der Welt
                if (collisionEnemys.length > 0 && collisionWorld.length === 0)
                {
                    //console.log("Zeile2");
                    enemy.translateX(+enemySpeedZombie);
                }
                else
                {
                    
                }

                rayCasterEnemy = new THREE.Raycaster(new THREE.Vector3(enemy.position.x, enemy.position.y, enemy.position.z), new THREE.Vector3(0, 1, 0), 0, 1);       //Raycaster für den Player
                collisionEnemys = rayCasterEnemy.intersectObjects(playerarray);         //Abfrage für den Player
                collisionWorld = rayCasterWorld.intersectObjects(colliderObject);
                
                if (collisionEnemys.length > 0)
                {
                    //console.log("Zeile3");
                    var indexWorld = colliderObject.indexOf(enemy);
                    var indexEnemy = enemyObject.indexOf(enemy);
                    if(indexWorld > -1 && indexEnemy > -1)
                    {
                        colliderObject.splice(indexWorld, 1);
                        enemyObject.splice(indexEnemy, 1);
                        spawnLoot(enemy);
                        scene.remove(enemy);
                    }
                    //delete colliderObject[index-1];
                }

            }
//---------------------------------------------------------------------------------------------------
            function spawnLoot(enemy)
            {
                var locationX=enemy.position.x;
                var locationY=enemy.position.y+1;
                
                var luckyNumber=Math.floor((Math.random() * 100) + 1);
                if(luckyNumber >= 0 && luckyNumber <= 30)
                {
                    alert("Zahl: "+luckyNumber+" Position X:Y :"+locationX+":"+locationY+" Objekt:Herz");
                }
                else if(luckyNumber > 30 && luckyNumber <= 60)
                {
                    alert("Zahl: "+luckyNumber+" Position X:Y :"+locationX+":"+locationY+" Objekt: Nix");
                }
                else if(luckyNumber > 60 && luckyNumber <= 100)
                {
                    alert("Zahl: "+luckyNumber+" Position X:Y :"+locationX+":"+locationY+" Objekt: Item");
                }
                
            }
//---------------------------------------------------------------------------------------------------
            function collisionDetection()
            {
                oldy = player.position.y;
                ray = [
                    new THREE.Vector3(player.position.x, player.position.y - 1, player.position.z),
                    new THREE.Vector3(player.position.x, player.position.y, player.position.z),
                    new THREE.Vector3(player.position.x, player.position.y + 1, player.position.z),
                    new THREE.Vector3(player.position.x - 0.27, player.position.y, player.position.z),
                    new THREE.Vector3(player.position.x, player.position.y, player.position.z),
                    new THREE.Vector3(player.position.x + 0.27, player.position.y, player.position.z)
                ];
                //Right
                for (var i = 0; i < 3; i++)
                {
                    rayCaster = new THREE.Raycaster(ray[i], new THREE.Vector3(1, 0, 0), 0, 0.27);
                    collisionObjects = rayCaster.intersectObjects(colliderObject);
                    collisionEnemy = rayCaster.intersectObjects(enemyObject);
                    if (collisionObjects.length > 0)//&& collisions[0].distance <= distancewd
                    {
                        player.position.x = oldx;
                        if (collisionEnemy.length > 0)
                        {
                            if(!isInvincible)
                            {
                                healthStatus(true);
                            }
                            else
                            {
                                if(invincibleTimer.getElapsedTime() >= 3)
                                {
                                    isInvincible=false;
                                }
                            }
                        }
                    }
                }
                //Left
                for (var i = 0; i < 3; i++)
                {
                    rayCaster = new THREE.Raycaster(ray[i], new THREE.Vector3(-1, 0, 0), 0, 0.27);
                    collisionObjects = rayCaster.intersectObjects(colliderObject);
                    collisionEnemy = rayCaster.intersectObjects(enemyObject);
                    if (collisionObjects.length > 0)//&& collisions[0].distance <= distancewd
                    {
                        player.position.x = oldx;
                        //console.log(collisionEnemy.length);
                        if (collisionEnemy.length > 0)
                        {
                            
                            if(!isInvincible)
                            {
                                healthStatus(true);
                            }
                            else
                            {
                                if(invincibleTimer.getElapsedTime() >= 3)
                                {
                                    isInvincible=false;
                                }
                            }
                        }
                    }
                }

                //Up
                for (var i = 3; i < 6; i++)
                {
                    rayCaster = new THREE.Raycaster(ray[i], new THREE.Vector3(0, 1, 0), 0, 1);
                    collisionObjects = rayCaster.intersectObjects(colliderObject);
                    collisionEnemy = rayCaster.intersectObjects(enemyObject);
                    if (collisionObjects.length > 0)//&& collisions[0].distance <= distancewd
                    {
                        player.position.y = oldy;
                        //console.log(collisionEnemy.length);
                        if (collisionEnemy.length > 0)
                        {
                            if(!isInvincible)
                            {
                                healthStatus(true);
                            }
                            else
                            {
                                if(invincibleTimer.getElapsedTime() >= 3)
                                {
                                    isInvincible=false;
                                }
                            }
                        }

                    }
                }

                //Down
                for (var i = 3; i < 6; i++)
                {
                    rayCaster = new THREE.Raycaster(ray[i], new THREE.Vector3(0, -1, 0), 0, 1.001);
                    collisionObjects = rayCaster.intersectObjects(colliderObject);
                    if (collisionObjects.length > 0)//&& collisions[0].distance <= distancewd
                    {
//                                player.position.y=oldy;
                        rayGround[i - 3] = true;
                    }
                    else
                    {
                        rayGround[i - 3] = false;
                    }
                }
                if (rayGround[0] || rayGround[1] || rayGround[2])
                {
                    isGround = true;
                }
                else
                {
                    isGround = false;
                    player.translateY(-0.05);
                }
            }

//---------------------------------------------------------------------------------------------------
            function keyboardInput()
            {
                $(document).keydown(function (e) {
                    switch (e.keyCode) {
                        case 65:
                            controls.left = true;
                            break;
                        case 87:
                            controls.up = true;
                            break;
                        case 68:
                            controls.right = true;
                            break;
                        case 83:
                            controls.down = true;
                            break;
                    }
                });
                $(document).keyup(function (e) {
                    switch (e.keyCode) {
                        case 65:
                            controls.left = false;
                            break;
                        case 87:
                            controls.up = false;
                            jumptime = 0;
                            break;
                        case 68:
                            controls.right = false;
                            break;
                        case 83:
                            controls.down = false;
                            break;
                    }
                });
                playerControls();
            }
//---------------------------------------------------------------------------------------------------
            function playerControls()
            {
                var move = 3 * clock.getDelta();

                if (isGround)
                {
                    jumpReady = true;
                }
                if (controls.left == true)
                {
                    oldx = player.position.x;
                    player.translateX(-move);
                }
                if (controls.right == true)
                {
                    oldx = player.position.x;
                    player.translateX(move);
                }
                if (controls.up == true)
                {
//                             oldy=player.position.y;
                    jumptime += 10 * clock.getDelta();
                    if (jumptime <= 1 && jumpReady)
                    {
                        player.translateY(0.15);
                    }
                }
                else
                {
                    jumpReady = false;
                }
            }

            function healthStatus(status)
            {

                    if (status === true)
                    {
                        isInvincible=true;
                        health -= 1;
                        console.log(health);
                        invincibleTimer = new THREE.Clock();
                    }

                    else if (status === false && health < maxHealth)
                    {
                        health += 1;
                        console.log(health);
                    }

                    if (health <= 0)
                    {
                        console.log("TOT");
                        console.log(health);
                    }
            }
        </script>
    </body>

</html>